<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Panel de Administración</title>
<script src="https://cdn.tailwindcss.com"></script>
<style>
@import url('https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;500;600;700&display=swap');
body { font-family: 'Playfair Display', serif; }
.modal { display: none; position: fixed; z-index: 100; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.4); justify-content: center; align-items: center; }
.modal-content { background-color: #fff; padding: 24px; border-radius: 12px; text-align: center; box-shadow: 0 4px 6px rgba(0,0,0,0.1); max-width: 400px; width: 90%; }
</style>
</head>
<body class="bg-[#F8F4EF] min-h-screen flex flex-col items-center py-12 px-4 sm:px-6 lg:px-8">

<div class="text-center mb-10">
    <h1 class="text-4xl font-bold text-gray-700">PANEL DE ADMINISTRACIÓN</h1>
    <p class="text-xl font-medium text-[#7C9A92] mt-2">Bienvenid@</p>
</div>

<div id="appContainer" class="w-full max-w-4xl flex flex-col items-center"></div>

<div id="confirmationModal" class="modal">
    <div class="modal-content">
        <p id="modalMessage" class="text-lg font-medium text-gray-800 mb-6"></p>
        <div class="flex justify-center space-x-4">
            <button id="confirmBtn" class="px-6 py-2 rounded-full text-white bg-red-600 hover:bg-red-700">Eliminar</button>
            <button id="cancelBtn" class="px-6 py-2 rounded-full text-gray-700 bg-gray-200 hover:bg-gray-300">Cancelar</button>
        </div>
    </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
import { getFirestore, collection, doc, addDoc, updateDoc, deleteDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

// Configura Firebase
const firebaseConfig = {
    apiKey: "TU_API_KEY",
    authDomain: "TU_AUTH_DOMAIN",
    projectId: "TU_PROJECT_ID",
    storageBucket: "TU_STORAGE_BUCKET",
    messagingSenderId: "TU_MESSAGING_SENDER_ID",
    appId: "TU_APP_ID"
};
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

let userId = null;
let teachers = [], assignments = [], users = [];
let currentEditingItem = { teachers: null, assignments: null, users: null };

// Modal
const confirmationModal = document.getElementById('confirmationModal');
const modalMessage = document.getElementById('modalMessage');
const confirmBtn = document.getElementById('confirmBtn');
const cancelBtn = document.getElementById('cancelBtn');
const showConfirmationModal = (message, onConfirm) => {
    modalMessage.textContent = message;
    confirmationModal.style.display = 'flex';
    confirmBtn.onclick = () => { onConfirm(); confirmationModal.style.display='none'; };
    cancelBtn.onclick = () => { confirmationModal.style.display='none'; };
};

// LOGIN
const showLogin = async (errorMessage = '') => {
    const appContainer = document.getElementById('appContainer');

    // Traer usuario y contraseña guardados
    const savedUsername = localStorage.getItem('savedUsername') || '';
    const savedPassword = localStorage.getItem('savedPassword') || '';

    appContainer.innerHTML = `
        <div class="bg-white p-10 rounded-3xl shadow-2xl w-full max-w-sm">
            <h2 class="text-2xl font-bold text-gray-700 mb-6 text-center">Acceso Requerido</h2>
            <form id="loginForm" class="space-y-6">
                <input type="text" id="usernameInput" placeholder="Usuario" required class="w-full px-4 py-2 border rounded-full" value="${savedUsername}">
                <input type="password" id="passwordInput" placeholder="Contraseña" required class="w-full px-4 py-2 border rounded-full" value="${savedPassword}">
                ${errorMessage ? `<p class="text-red-500 text-sm text-center">${errorMessage}</p>` : ''}
                <button type="submit" class="w-full py-3 px-5 rounded-full bg-green-500 text-white font-bold">ACCEDER</button>
            </form>
        </div>
    `;

    document.getElementById('loginForm').addEventListener('submit', async e => {
        e.preventDefault();
        const username = document.getElementById('usernameInput').value;
        const password = document.getElementById('passwordInput').value;

        if(username === "Admin" && password === "123456789") {
            localStorage.setItem('savedUsername', username);
            localStorage.setItem('savedPassword', password);
            userId = "demoUser";
            showPanel();
        } else {
            showLogin("Usuario o contraseña incorrectos.");
        }
    });
};

// Funciones de renderizado
const renderTeachersTable = () => {
    const tbody = document.getElementById('teachersTableBody'); if(!tbody) return;
    tbody.innerHTML = teachers.map(t => `
        <tr data-id="${t.id}">
            <td class="px-6 py-4">${t.name}</td>
            <td class="px-6 py-4">${t.group}</td>
            <td class="px-6 py-4">
                <button class="edit-btn text-[#7C9A92] mr-2">Editar</button>
                <button class="delete-btn text-red-600">Eliminar</button>
            </td>
        </tr>`).join('');
};
const renderAssignmentsTable = () => {
    const tbody = document.getElementById('assignmentsTableBody'); if(!tbody) return;
    tbody.innerHTML = assignments.map(a => `
        <tr data-id="${a.id}">
            <td class="px-6 py-4">${a.teacher}</td>
            <td class="px-6 py-4">${a.group}</td>
            <td class="px-6 py-4">${a.subject}</td>
            <td class="px-6 py-4">
                <button class="edit-btn text-[#7C9A92] mr-2">Editar</button>
                <button class="delete-btn text-red-600">Eliminar</button>
            </td>
        </tr>`).join('');
};
const renderUsersTable = () => {
    const tbody = document.getElementById('usersTableBody'); if(!tbody) return;
    tbody.innerHTML = users.map(u => `
        <tr data-id="${u.id}">
            <td class="px-6 py-4">${u.name}</td>
            <td class="px-6 py-4">${u.email}</td>
            <td class="px-6 py-4">${u.role}</td>
            <td class="px-6 py-4">
                <button class="edit-btn text-[#7C9A92] mr-2">Editar</button>
                <button class="delete-btn text-red-600">Eliminar</button>
            </td>
        </tr>`).join('');
};

// PANEL DE ADMINISTRACIÓN
const showPanel = () => {
    const appContainer = document.getElementById('appContainer');
    appContainer.innerHTML = `
        <div class="flex flex-wrap justify-center space-x-4 mb-10">
            <button id="teachersBtn" class="px-6 py-3 rounded-full bg-green-500 text-white">Grupo y Docentes</button>
            <button id="assignmentsBtn" class="px-6 py-3 rounded-full bg-gray-200 text-gray-700">Asignaciones</button>
            <button id="usersBtn" class="px-6 py-3 rounded-full bg-gray-200 text-gray-700">Usuarios</button>
        </div>
        <div id="contentContainer"></div>
    `;

    const contentContainer = document.getElementById('contentContainer');
    const teachersBtn = document.getElementById('teachersBtn');
    const assignmentsBtn = document.getElementById('assignmentsBtn');
    const usersBtn = document.getElementById('usersBtn');

    const sections = {
        teachers: `<div class="p-8 bg-white rounded-3xl shadow-xl w-full">
                <h2 class="text-2xl font-bold mb-4">Gestión de Docentes</h2>
                <form id="teacherForm" class="space-y-4">
                    <input type="text" id="teacherName" placeholder="Nombre del docente" required class="w-full px-4 py-2 border rounded-full">
                    <input type="text" id="teacherGroup" placeholder="Grupo asignado" required class="w-full px-4 py-2 border rounded-full">
                    <button type="submit" id="submitTeacherBtn" class="w-full py-3 px-5 rounded-full bg-green-500 text-white font-bold">Agregar Docente</button>
                </form>  
                <table class="min-w-full divide-y divide-gray-200 mt-4">
                    <thead><tr><th>Nombre</th><th>Grupo</th><th>Acciones</th></tr></thead>
                    <tbody id="teachersTableBody"></tbody>
                </table>
            </div>`,
        assignments: `<div class="p-8 bg-white rounded-3xl shadow-xl w-full">
                <h2 class="text-2xl font-bold mb-4">Gestión de Asignaciones</h2>
                <form id="assignmentForm" class="space-y-4">
                    <input type="text" id="assignmentTeacher" placeholder="Docente" required class="w-full px-4 py-2 border rounded-full">
                    <input type="text" id="assignmentGroup" placeholder="Grupo" required class="w-full px-4 py-2 border rounded-full">
                    <input type="text" id="assignmentSubject" placeholder="Materia" required class="w-full px-4 py-2 border rounded-full">
                    <button type="submit" class="w-full py-3 px-5 rounded-full bg-green-500 text-white font-bold">Agregar Asignación</button>
                </form>
                <table class="min-w-full divide-y divide-gray-200 mt-4">
                    <thead><tr><th>Docente</th><th>Grupo</th><th>Materia</th><th>Acciones</th></tr></thead>
                    <tbody id="assignmentsTableBody"></tbody>
                </table>
            </div>`,
        users: `<div class="p-8 bg-white rounded-3xl shadow-xl w-full">
                <h2 class="text-2xl font-bold mb-4">Gestión de Usuarios</h2>
                <form id="userForm" class="space-y-4">
                    <input type="text" id="userName" placeholder="Nombre" required class="w-full px-4 py-2 border rounded-full">
                    <input type="email" id="userEmail" placeholder="Correo" required class="w-full px-4 py-2 border rounded-full">
                    <select id="userRole" class="w-full px-4 py-2 border rounded-full"><option>Administrador</option><option>Usuario</option></select>
                    <button type="submit" class="w-full py-3 px-5 rounded-full bg-green-500 text-white font-bold">Agregar Usuario</button>
                </form>
                <table class="min-w-full divide-y divide-gray-200 mt-4">
                    <thead><tr><th>Nombre</th><th>Correo</th><th>Rol</th><th>Acciones</th></tr></thead>
                    <tbody id="usersTableBody"></tbody>
                </table>
            </div>`
    };

    const switchContent = (section) => {
        contentContainer.innerHTML = sections[section];
        teachersBtn.className = "px-6 py-3 rounded-full bg-gray-200 text-gray-700";
        assignmentsBtn.className = "px-6 py-3 rounded-full bg-gray-200 text-gray-700";
        usersBtn.className = "px-6 py-3 rounded-full bg-gray-200 text-gray-700";
        if(section==='teachers') teachersBtn.className="px-6 py-3 rounded-full bg-green-500 text-white";
        if(section==='assignments') assignmentsBtn.className="px-6 py-3 rounded-full bg-green-500 text-white";
        if(section==='users') usersBtn.className="px-6 py-3 rounded-full bg-green-500 text-white";
        setupEventListeners(section);
    };

    teachersBtn.onclick = () => switchContent('teachers');
    assignmentsBtn.onclick = () => switchContent('assignments');
    usersBtn.onclick = () => switchContent('users');

    // Eventos de agregar, editar y eliminar
    const setupEventListeners = (section) => {
        if(section==='teachers'){
            const form = document.getElementById('teacherForm');
            form.onsubmit = async e => {
                e.preventDefault();
                const name = document.getElementById('teacherName').value;
                const group = document.getElementById('teacherGroup').value;
                if(currentEditingItem.teachers){
                    const ref = doc(db, `users/${userId}/teachers/${currentEditingItem.teachers.id}`);
                    await updateDoc(ref, {name, group});
                    currentEditingItem.teachers=null;
                } else {
                    await addDoc(collection(db, `users/${userId}/teachers`), {name, group});
                }
                form.reset();
            };
            document.querySelectorAll('.edit-btn').forEach((btn, i) => {
                btn.onclick = ()=>{ 
                    const t=teachers[i];
                    document.getElementById('teacherName').value=t.name;
                    document.getElementById('teacherGroup').value=t.group;
                    currentEditingItem.teachers=t;
                };
            });
            document.querySelectorAll('.delete-btn').forEach((btn, i)=>{
                btn.onclick=()=>showConfirmationModal("¿Eliminar docente?", async ()=>{ 
                    await deleteDoc(doc(db, `users/${userId}/teachers/${teachers[i].id}`));
                });
            });
        }
        if(section==='assignments'){
            const form = document.getElementById('assignmentForm');
            form.onsubmit = async e => {
                e.preventDefault();
                const teacher = document.getElementById('assignmentTeacher').value;
                const group = document.getElementById('assignmentGroup').value;
                const subject = document.getElementById('assignmentSubject').value;
                if(currentEditingItem.assignments){
                    const ref = doc(db, `users/${userId}/assignments/${currentEditingItem.assignments.id}`);
                    await updateDoc(ref, {teacher, group, subject});
                    currentEditingItem.assignments=null;
                } else {
                    await addDoc(collection(db, `users/${userId}/assignments`), {teacher, group, subject});
                }
                form.reset();
            };
            document.querySelectorAll('.edit-btn').forEach((btn, i) => {
                btn.onclick = ()=>{ 
                    const a=assignments[i];
                    document.getElementById('assignmentTeacher').value=a.teacher;
                    document.getElementById('assignmentGroup').value=a.group;
                    document.getElementById('assignmentSubject').value=a.subject;
                    currentEditingItem.assignments=a;
                };
            });
            document.querySelectorAll('.delete-btn').forEach((btn, i)=>{
                btn.onclick=()=>showConfirmationModal("¿Eliminar asignación?", async ()=>{ 
                    await deleteDoc(doc(db, `users/${userId}/assignments/${assignments[i].id}`));
                });
            });
        }
        if(section==='users'){
            const form = document.getElementById('userForm');
            form.onsubmit = async e => {
                e.preventDefault();
                const name = document.getElementById('userName').value;
                const email = document.getElementById('userEmail').value;
                const role = document.getElementById('userRole').value;
                if(currentEditingItem.users){
                    const ref = doc(db, `users/${userId}/users/${currentEditingItem.users.id}`);
                    await updateDoc(ref, {name,email,role});
                    currentEditingItem.users=null;
                } else {
                    await addDoc(collection(db, `users/${userId}/users`), {name,email,role});
                }
                form.reset();
            };
            document.querySelectorAll('.edit-btn').forEach((btn, i) => {
                btn.onclick = ()=>{ 
                    const u=users[i];
                    document.getElementById('userName').value=u.name;
                    document.getElementById('userEmail').value=u.email;
                    document.getElementById('userRole').value=u.role;
                    currentEditingItem.users=u;
                };
            });
            document.querySelectorAll('.delete-btn').forEach((btn, i)=>{
                btn.onclick=()=>showConfirmationModal("¿Eliminar usuario?", async ()=>{ 
                    await deleteDoc(doc(db, `users/${userId}/users/${users[i].id}`));
                });
            });
        }
    };

    // Suscripciones a Firestore
    onSnapshot(collection(db, `users/${userId}/teachers`), snapshot => {
        teachers = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
        renderTeachersTable();
    });
    onSnapshot(collection(db, `users/${userId}/assignments`), snapshot => {
        assignments = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
        renderAssignmentsTable();
    });
    onSnapshot(collection(db, `users/${userId}/users`), snapshot => {
        users = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
        renderUsersTable();
    });

    switchContent('teachers');
};

// Inicializa login
showLogin();
</script>
</body>
</html>
